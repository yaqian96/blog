---
title: 动态表格
date: 2022-01-26
permalink:
categories:
  - JavaScript
tags:
  - null
---

```js
<template>
  <div class="idass-table">
    <el-table
      :data="localdata"
      v-bind="$attrs"
      v-on="$listeners"
      ref="table"
      :max-height="maxHeight"
      :height="height"
      :row-class-name="clickNodeClassName"
    >
      <slot name="before"></slot>
      <template v-for="(item, index) in columns">
        <el-table-column
          :formatter="formatter"
          v-bind="item"
          :key="`col_${index}_${item.prop || item.type}`"
        >
          <template v-if="item.slotName" v-slot="{ row, column, $index }">
            <error-tips
              v-if="editable"
              :row="row"
              :prop="item.prop"
              :idName="idName"
            ></error-tips>
            <slot
              :name="row.isEdit ? `${item.slotName}Edit` : item.slotName"
              v-bind="{
                row,
                column,
                $index,
                validateField: () => validateField(row, item.prop),
              }"
            >
              <Tooltip
                :content="row[item.prop] | ArrToString"
                placement="top-start"
              >
                <div class="hideText">
                  {{ row[item.prop] | ArrToString }}
                </div>
              </Tooltip>
            </slot>

            <!-- <div
              v-if="row.isEdit && row.errorRow[item.prop]"
              class="tooltip-cj hideText"
            >
              {{ row.errorMassge[item.prop] }}
            </div> -->
          </template>
          <template
            v-else-if="!item.type && !item.showOverflowTooltip"
            v-slot="{ row }"
          >
            <Tooltip
              :content="row[item.prop] | ArrToString"
              placement="top-start"
            >
              <div class="hideText">
                {{ row[item.prop] | ArrToString }}
              </div>
            </Tooltip>
          </template>
          <template v-if="item.slotHeader" v-slot:header="{ column, $index }">
            <slot :name="item.slotHeader" v-bind="{ column, $index }"></slot>
          </template>
          <template v-else v-slot:header="{ column }">
            <div>
              <Tooltip :content="column.label" placement="top-start">
                <div class="hideText" ref="headerName">{{ column.label }}</div>
              </Tooltip>
            </div>
          </template>
        </el-table-column>
      </template>
      <slot></slot>
      <template slot="empty">
        <idaas-empty></idaas-empty>
      </template>
    </el-table>
    <el-pagination
      v-if="!paginationHide && pageProps.total > 10"
      style="margin-top: 30px; text-align: right"
      v-bind="pageProps"
      @current-change="currentChange"
      @size-change="sizeChange"
    ></el-pagination>
  </div>
</template>

<script>
  import AsyncValidator from 'async-validator'
  import { cloneDeep } from 'lodash'
  import Tooltip from '@/components/idaas-tooltips/index'
  import ErrorTips from './error-tips.vue'
  export default {
    components: { ErrorTips },
    name: 'idaas-table',
    inheritAttrs: false,
    props: {
      activeKey: {
        type: String,
      },
      activeValue: {
        type: [String, Number],
      },
      maxHeight: {
        type: String,
        // default: '300px',
      },
      height: {
        type: Number,
      },
      columns: {
        type: Array,
        required: true,
        default: () => [],
      },
      data: {
        type: Array,
        default: () => [],
      },
      editable: {
        type: Boolean,
        default: false,
      },
      idName: String,

      //分页页码属性配置
      paginationProps: {
        type: Object,
        default: () => ({}),
      },
      paginationHide: {
        type: Boolean,
        default: false,
      },
      //分页页码改变回调函数
      currentChange: {
        type: Function,
        default: () => {},
      },
      // 分页size改变回调函数
      sizeChange: {
        type: Function,
        default: () => {},
      },
      rules: {
        type: Object,
        default: () => ({}),
      },
      isBottom: {
        type: Boolean,
        default: false,
      },
    },
    computed: {
      localdata({ editable, data, columns }) {
        if (editable) {
          let errorRow = {}
          let errorMassge = {}
          columns.forEach((e) => {
            if (!e.prop) return
            errorRow[e.prop] = false
            errorMassge[e.prop] = ''
          })
          return data.map((e) => {
            let isEdit = e.isEdit || false

            // e.isEdit && delete e.isEdit
            let editRow = cloneDeep(e)
            delete editRow.isEdit

            return {
              ...e,
              isEdit: isEdit,
              errorRow: { ...errorRow },
              errorMassge: { ...errorMassge },
              editRow: editRow,
            }
          })
        }
        return data
      },

      pageProps() {
        return {
          total: 0,
          background: true,
          layout: 'total, sizes, prev, pager, next, jumper',
          ...this.paginationProps,
        }
      },
    },
    watch: {
      data: {
        immediate: true,
        deep: true,
        handler(n) {
          this.$forceUpdate()
          if (this.isBottom) {
            this.$nextTick(() => {
              this.$refs.table.bodyWrapper.scrollTop =
                this.$refs.table.bodyWrapper.scrollHeight
            })
          }
        },
      },
    },
    methods: {
      showHeadTip(el) {
        console.log(el)
        return true
      },
      clickNodeClassName({ row }) {
        if (this.activeValue && row[this.activeKey] == this.activeValue) {
          return 'item-active'
        }
      },
      formatter(row, column, cellValue, index) {
        return ['', null, undefined].includes(cellValue) ? '-' : cellValue
      },
      validate(row) {
        if (!this.editable) {
          return Promise.resolve(true)
        }

        const hasOwnProperty = (obj, key) =>
          Object.prototype.hasOwnProperty.call(obj, key)

        return new Promise((resolve, reject) => {
          let data = { ...row.editRow }
          let newRules = {}
          const rules = this.rules

          Object.keys(row.editRow).map((key) => {
            if (hasOwnProperty(rules, key)) {
              newRules[key] = rules[key]
            }
          })

          const validator = new AsyncValidator(newRules)
          validator.validate(data, { firstFields: true }, (errors, fields) => {
            if (errors) {
              errors.map((e) => {
                row.errorRow[e.field] = true
                row.errorMassge[e.field] = e.message
              })
              resolve(false)
            } else {
              this.columns.forEach((e) => {
                if (!e.prop) return
                row.errorRow[e.prop] = false
                row.errorMassge[e.prop] = ''
              })
              resolve(true)
            }
          })
        })
      },
      validateField(row, prop) {
        let data = {}
        let rules = {}
        rules[prop] = this.rules[prop]
        data[prop] = row.editRow[prop]

        const validator = new AsyncValidator(rules)
        validator.validate(data, { firstFields: true }, (errors, fields) => {
          const isError = !!errors
          const message = isError ? errors[0].message : ''

          row.errorRow[prop] = isError
          row.errorMassge[prop] = message
        })
      },
      scrollBottom() {
        this.$nextTick(() => {
          this.$refs.table.bodyWrapper.scrollTop =
            this.$refs.table.bodyWrapper.scrollHeight
        })
      },
    },
  }
</script>
```

## 使用参考 views/example/idaas-table

## 参数说明

| 属性            | 说明                                           | 类型     | 默认值                                                   |
| --------------- | ---------------------------------------------- | -------- | -------------------------------------------------------- |
| columns         | 列表列得配置，属性参考 element-ui table-column | array    | []                                                       |
| editable        | 是否是编辑表格                                 | boolean  | false                                                    |
| paginationProps | 分页组件参数                                   | object   | `{background: true,layout: 'total, prev, pager, next',}` |
| currentChange   | 页码改变之后回到                               | function | function(page:number)                                    |
| rules           | 验证规则，与 form 表单一致                     | object   | {}                                                       |

## 实例方法

`validate`方法，需要传递验证行得数据`row`，返回一个`Promise` `.then`里回调参数 `true` 表示验证通过 `false` 表示失败

## 命名 slot

`columns`配置选项中新增`slotName`属性，作为插槽命名
插槽是自定义显示方式，参数`{row,column,$index}`

## 编辑状态下 slot

编辑状态下，插槽命名增加`Edit`  
例如：插槽名为`name`那么编辑下插槽命名`nameEdit`，参数`{row,column,$index, validateField}`  
`validateField`方法是自动验证数据使用，绑定输入框和 select 等组件的`blur` `change`事件。  
`row`增加`isEdit`属性，作为编辑的状态切换； 增加`editRow`属性，作为编辑数据,与原始的`row`一致

## header slot

`columns` 配置选中增加 `slotHeader` 属性，作为`header`插槽命名  
`header`插槽是自定义`header`的显示方式，参数`{column, $index}`

## 新增编辑行

直接向数据列表`push`一条数据，数据中需要带`isEdit`属性为`true`

其他未列举的参数、事件和方法请参考 table 组件
